name: CI - Quality Gate (Security + Code) and Build

on: [push, pull_request]

jobs:
  scan_gitguardian:
    name: Scan (GitGuardian) - Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate GitGuardian token (health)
        shell: bash
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        run: |
          if [ -z "$GITGUARDIAN_API_KEY" ]; then
            echo "GITGUARDIAN_API_KEY is EMPTY (secret non letto o nome sbagliato)."
            exit 1
          fi

          curl -fsS -H "Authorization: Token ${GITGUARDIAN_API_KEY}" \
            https://api.gitguardian.com/v1/health >/dev/null

          echo "GitGuardian token OK"
      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
