name: Java CI/CD Pipeline (Security, Quality, Docker)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-secure-and-deploy:
    name: Build, Secure, Analyze & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    # Servizio MySQL condiviso per Test e Analisi
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin 
          MYSQL_DATABASE: second_chance
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -u root -padmin"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
    # 1. CHECKOUT (Con cronologia completa per GitGuardian e Sonar)
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    # 2. SECURITY SCAN - SECRETS (GitGuardian)
    # Eseguito subito per bloccare commit con password
    - name: GitGuardian scan
      uses: GitGuardian/ggshield/actions/secret@v1.46.0
      env:
        GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
        GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
        GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

    # 3. SECURITY SCAN - DEPENDENCIES (Snyk)
    - name: Setup Snyk CLI
      uses: snyk/actions/setup@v1.0.0
      with:
        snyk-version: latest

    - name: Snyk test (Fail on High/Critical)
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      # Continua anche se trova vulnerabilit√† basse/medie, ma fallisce su quelle alte
      run: snyk test --all-projects --severity-threshold=high

    # 4. SETUP JAVA & CACHING
    - name: Set up JDK 19
      uses: actions/setup-java@v4
      with:
        java-version: '19'
        distribution: 'temurin'
        cache: maven

    # Cache specifica per SonarQube per velocizzare l'analisi
    - name: Cache SonarQube packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    # 5. DATABASE INIT
    - name: Initialize Database
      run: |
        mysql -h 127.0.0.1 -P 3306 -u root -padmin second_chance < db_import.sql

    # 6. BUILD, TEST & ANALYZE (Tutto in uno)
    # Esegue: Clean, Verify (Test), Pitest (Mutation), SonarQube Analysis
    - name: Build, Test (Pitest) and Sonar Analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Necessario per Sonar
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn -B clean verify -P pitest \
        org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
        -Dsonar.projectKey=Mattyx00_2chance-dependability
      #-Dsonar.qualitygate.wait=true
    # 7. UPLOAD COVERAGE (Codecov)
    # Eseguito se i test passano (run precedente)
    - name: Upload coverage and test results to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: |
          target/site/jacoco/jacoco.xml
          target/pit-reports/mutations.xml
          target/surefire-reports/TEST-*.xml
        fail_ci_if_error: true

    # 8. DOCKER BUILD & PUSH
    # Questo step viene eseguito SOLO se tutti gli step precedenti (Sicurezza e Test) sono verdi
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/2chance-dependability:latest